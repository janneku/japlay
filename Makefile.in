CC = {CC}
PREFIX = {PREFIX}
LIBPATH = {LIBPATH}
CFLAGS = -O2 -W -Wall `pkg-config ao glib-2.0 --cflags` -g -pthread -pedantic -std=c99
LDFLAGS = `pkg-config ao glib-2.0 gthread-2.0 --libs` -lpthread
PLUGIN_CFLAGS = $(CFLAGS) -fPIC
PLUGIN_LDFLAGS = $(LDCFLAGS) -shared

OBJ = main.o utils.o playlist.o unixsocket.o buffer.o hashmap.o settings.o
PLUGIN_OBJS = in_mad.o in_mikmod.o in_vorbis.o ui_gtk.o
GTK_BINARY = japlay
PLUGINS = {PLUGINS} pl_m3u.so pl_pls.so

all: $(GTK_BINARY) $(PLUGINS)

main.o:	main.c config.h

in_mad.o:	in_mad.c
	$(CC) $(PLUGIN_CFLAGS) `pkg-config mad --cflags` -c $<

in_mikmod.o:	in_mikmod.c
	$(CC) $(PLUGIN_CFLAGS) `libmikmod-config --cflags` -c $<

in_vorbis.o:	in_vorbis.c
	$(CC) $(PLUGIN_CFLAGS) `pkg-config vorbisfile --cflags` -c $<

ui_gtk.o:	ui_gtk.c
	$(CC) $(CFLAGS) `pkg-config gtk+-2.0 --cflags` -c $<

pl_m3u.o:	pl_m3u.c
	$(CC) $(PLUGIN_CFLAGS) -c $<

pl_pls.o:	pl_pls.c
	$(CC) $(PLUGIN_CFLAGS) -c $<

%.o:	%.c
	$(CC) $(CFLAGS) -c $<

$(GTK_BINARY):	$(OBJ) ui_gtk.o
	$(CC) $(OBJ) ui_gtk.o -o $@ $(LDFLAGS) -Wl,-E `pkg-config gtk+-2.0 --libs`

install:	$(GTK_BINARY) $(PLUGINS)
	install -m 755 japlay $(DESTDIR)$(PREFIX)/bin
	mkdir -p -m 755 $(DESTDIR)$(LIBPATH)/japlay
	install -m 755 $(PLUGINS) $(DESTDIR)$(LIBPATH)/japlay

clean:
	rm -f $(OBJ) $(PLUGIN_OBJS) $(GTK_BINARY) $(PLUGINS)

in_mad.so:	in_mad.o
	$(CC) in_mad.o -o $@ $(PLUGIN_LDFLAGS) `pkg-config mad --libs`

in_mikmod.so:	in_mikmod.o
	$(CC) in_mikmod.o -o $@ $(PLUGIN_LDFLAGS) `libmikmod-config --libs`

in_vorbis.so:	in_vorbis.o
	$(CC) in_vorbis.o -o $@ $(PLUGIN_LDFLAGS) `pkg-config vorbisfile --libs`

pl_m3u.so:	pl_m3u.o
	$(CC) pl_m3u.o -o $@ $(PLUGIN_LDFLAGS)

pl_pls.so:	pl_pls.o
	$(CC) pl_pls.o -o $@ $(PLUGIN_LDFLAGS)

buffer.o: buffer.c buffer.h plugin.h common.h
hashmap.o: hashmap.c hashmap.h
in_mad.o: in_mad.c plugin.h playlist.h common.h utils.h
in_mikmod.o: in_mikmod.c common.h playlist.h utils.h plugin.h
in_vorbis.o: in_vorbis.c common.h playlist.h utils.h plugin.h
main.o: main.c japlay.h common.h utils.h playlist.h plugin.h ui.h list.h config.h buffer.h settings.h
playlist.o: playlist.c playlist.h common.h japlay.h ui.h list.h utils.h hashmap.h
pl_m3u.o: pl_m3u.c common.h japlay.h playlist.h utils.h plugin.h
pl_pls.o: pl_pls.c common.h japlay.h playlist.h utils.h plugin.h
settings.o: settings.c settings.h common.h list.h utils.h
ui_gtk.o: ui_gtk.c ui.h common.h japlay.h playlist.h utils.h unixsocket.h settings.h
unixsocket.o: unixsocket.c common.h unixsocket.h
utils.o: utils.c utils.h common.h

